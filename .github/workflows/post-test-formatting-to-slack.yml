name: Post formatted test message to Slack (chat.postMessage)

on:
  workflow_dispatch:
    inputs:
      testing:
        description: 'Run in testing mode with embedded mochawesome JSON'
        required: false
        default: 'false'
  push: {}

jobs:
  post-formatting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq


      - name: Ensure mochawesome JSON exists (testing)
        run: |
          mkdir -p tests_cypress/cypress/results
          FILE=tests_cypress/cypress/results/mochawesome.json
          if [ -f "$FILE" ]; then
            echo "mochawesome JSON already exists, leaving it in place"
            exit 0
          fi
          echo '{"results":[{"suites":[{"suites":[{"title":"GCA a11y tests [LOCAL]","suites":[{"title":"English","tests":[{"fullTitle":"GCA a11y tests [LOCAL] English /terms","state":"failed","err":{"message":"CypressError: `cy.request()` failed trying to load:\nhttps://www.bokren-link.ca/\nError: getaddrinfo ENOTFOUND www.bokren-link.ca"}}]},{"title":"Francais","tests":[{"fullTitle":"GCA a11y tests [LOCAL] Francais /privacy","state":"failed","err":{"message":"CypressError: `cy.request()` failed trying to load:\nhttps://www.bokren-link.ca/\nError: getaddrinfo ENOTFOUND www.bokren-link.ca"}}]}]}]}]}]}' > tests_cypress/cypress/results/mochawesome.json

      - name: Read and build failure previews
        id: build
        run: |
          set -euo pipefail
          FILE=tests_cypress/cypress/results/mochawesome.json
          if [ ! -f "$FILE" ]; then
            echo "No mochawesome found at $FILE" >&2
            echo "failures=[]" > /tmp/failures.json
            exit 0
          fi

          jq -c '[ .results[] | .. | objects
            | select(.state=="failed")
            | { fullTitle: (.fullTitle // .title), message: (.err.message // .err.estack // "No error") }
            ]
            | unique_by(.fullTitle)
            | map({ title: .fullTitle, preview: ( .message
                | split("\n")
                | map(gsub("^\\s+|\\s+$"; ""))
                | map(select(length>0))
                | .[0:5]
                | map("> " + .)
                | join("\n") ) })
            | .[0:5]' $FILE > /tmp/failures.json

          echo "Created /tmp/failures.json"
          jq . /tmp/failures.json || true

      - name: Post parent message (chat.postMessage)
        id: post_parent
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
        run: |
          set -euo pipefail
          if [ -z "${SLACK_BOT_TOKEN:-}" ] || [ -z "${SLACK_CHANNEL:-}" ]; then
            echo "SLACK_BOT_TOKEN or SLACK_CHANNEL secret missing" >&2
            exit 1
          fi

          PARENT_TEXT='*:rotating_light: Staging a11y tests failed :rotating_light:*'

          resp=$(curl -s -X POST -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" -H "Content-type: application/json" --data "$(jq -nc --arg ch "$SLACK_CHANNEL" --arg txt "$PARENT_TEXT" '{channel:$ch, text:$txt, mrkdwn:true}')" https://slack.com/api/chat.postMessage)

          echo "Parent response: $resp"
          ok=$(echo "$resp" | jq -r '.ok')
          if [ "$ok" != "true" ]; then
            echo "Failed to post parent message: $(echo "$resp" | jq -r '.error')" >&2
            exit 1
          fi

          ts=$(echo "$resp" | jq -r '.ts')
          echo "ts=$ts" >> $GITHUB_OUTPUT

      - name: Post threaded replies (max 5)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
        run: |
          set -euo pipefail
          TS="${{ steps.post_parent.outputs.ts }}"
          if [ -z "$TS" ]; then
            echo "No parent ts, skipping replies"
            exit 0
          fi

          mapfile -t items < <(jq -c '.[]' /tmp/failures.json)
          for item in "${items[@]}"; do
            title=$(echo "$item" | jq -r '.title')
            preview=$(echo "$item" | jq -r '.preview')
            # Build JSON body via jq to avoid shell/backtick issues
            body=$(jq -nc --arg ch "$SLACK_CHANNEL" --arg thread "$TS" --arg title "$title" --arg preview "$preview" '{channel:$ch, text: ("Test *`" + $title + "`* failed\n" + $preview + "\n\n:wavy_dash:"), thread_ts:$thread, mrkdwn:true}')

            echo "Posting reply for $title"
            curl -s -X POST -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" -H "Content-type: application/json" --data "$body" https://slack.com/api/chat.postMessage | jq . || true
            sleep 0.5
          done

