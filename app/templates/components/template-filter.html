{# This macro creates a filterable template list based on specified criteria. #}
{% macro template_filter(row_selector, notification_type_data_attribue, template_category_data_attribute) %}
    {# TODO: move these to a CSS file #}
    <style>
        .template_filter .active {
            background-color: #425A76;
            color: white;
        }
        .template_filter details >div {
            padding-left: 5px !important;
            box-shadow: none !important;
        }
    </style>
    {# Ensure all required parameters are provided #}
    {% if not row_selector or not notification_type_data_attribue or not template_category_data_attribute %}
        <div class="text-red font-bold my-4">
            Missing required parameters: <code>row_selector</code>, <code>notification_type_attribute</code>, and <code>template_category_attribute</code>. Please verify your code and try again.
        </div>
    {% else %}
        {# Main filter container with data attributes for dynamic filtering #}
        <div class="template_filter" data-row-selector="{{ row_selector }}">
            <details>
                <summary class="cursor-pointer text-sm">Apply filters</summary>
                <div class="flex p-0 pl-gutter mt-2">
                    {# Filter group for notification types #}
                    <div class="filters mr-10 border-l-4 border-gray-border" data-target="{{ notification_type_data_attribue }}">
                        <h3 class="font-medium text-sm text-gray-700 mb-2 pl-1">Type</h3>
                        <div class="space-y-1">
                            <a href="#" class="px-gutter block active" data-target="all">All</a>
                            <a href="#" class="px-gutter block" data-target="email">Email</a>
                            <a href="#" class="px-gutter block" data-target="sms">Text message</a>
                        </div>
                    </div>
                    {# Filter group for template categories #}
                    <div class="filters border-l-4 border-gray-border" data-target="{{ template_category_data_attribute }}">
                        <h3 class="font-medium text-sm text-gray-700 mb-2 pl-1">Category</h3>
                        <div class="space-y-1">
                            <a href="#" class="px-gutter block active" data-target="all">All</a>
                            <a href="#" class="px-gutter block" data-target="info-request">Information request</a>
                            <a href="#" class="px-gutter block" data-target="status-update">Status update</a>
                            <a href="#" class="px-gutter block" data-target="uncategorized">Uncategorized</a>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    
        {# TODO: Move this script to a separate JS file #}
        <script nonce="{{ request_nonce }}">
            const templateFilter = document.querySelector('.template_filter');
            const rowSelector = templateFilter.dataset.rowSelector;
        
            // Function to initialize event listeners on filter links
            function initializeFilterLinks() {
                document.querySelectorAll('.filters a').forEach(link => {
                    link.addEventListener('click', handleFilterClick);
                });
            }
        
            // Handle click events on filter links
            function handleFilterClick(event) {
                event.preventDefault();
                const clickedLink = event.target;
                const filterGroup = clickedLink.closest('.filters');
        
                // Remove 'active' class from all links in the current filter group
                filterGroup.querySelectorAll('a').forEach(link => link.classList.remove('active'));
        
                // Add 'active' class to the clicked link
                clickedLink.classList.add('active');
        
                // Apply filters based on the active selections
                applyFilters();
            }
        
            // Collect active filters and apply them to the rows
            function applyFilters() {
                const activeFilters = collectActiveFilters();
                filterRows(activeFilters);
            }
        
            // Collect active filters from the UI
            function collectActiveFilters() {
                const activeFilters = [];
                templateFilter.querySelectorAll('.filters').forEach(filterGroup => {
                    const activeLink = filterGroup.querySelector('.active');
                    activeFilters.push({
                        target: filterGroup.dataset.target,
                        value: activeLink.dataset.target
                    });
                });
                return activeFilters;
            }
        
            // Apply active filters to rows, showing or hiding them as necessary
            function filterRows(activeFilters) {
                document.querySelectorAll(rowSelector).forEach(row => {
                    const shouldShow = activeFilters.every(filter => {
                        return filter.value === 'all' || row.getAttribute(filter.target) === filter.value;
                    });
                    row.style.display = shouldShow ? 'block' : 'none';
                });
            }
        
            // Initialize the script
            initializeFilterLinks();
        </script>
    {% endif %}
{% endmacro %}