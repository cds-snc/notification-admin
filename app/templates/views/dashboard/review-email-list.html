{% extends "admin_template.html" %}

{% from "components/table.html" import list_table, notification_status_field, row_heading%}
{% from "components/ajax-block.html" import ajax_block %}
{% from "components/table.html" import list_table, link_field %}
{% from "components/show-more.html" import show_more %}

{% set address_single = _('address') %}
{% set address_plural = _('addresses') %}

{% block service_page_title %}
  {{ _('Review email addresses') }}
{% endblock %}

{% block maincolumn_content %}
    <div class="page-content">
        <h1 class="heading-large py-4">{{ _('Review email addresses') }}</h1>
        <p>{{ _("GC Notify's email provider could suspend our services if we send too many problem emails.") }}</p>
        <p>{{ _("<a href='{}'>Keep accurate contact information</a>. Check email addresses are correct. If necessary confirm recipientâ€™s email address using another contact method.").format(gca_url_for('delivery_failure')) }}</p>
        <p>{{ _('Remove addresses you cannot correct.') }}</p>

        <div class="{% if bounce_rate["bounce_status"] == "critical" %}review-email-status-critical{% elif bounce_rate["bounce_status"] == "warning"%}review-email-status-critical{% else%}review-email-status-normal{% endif %} px-5">
            <p class="text-title py-4">
                <i aria-hidden="true" class="px-1 fa-solid fa-fas fa-circle-exclamation"></i>
                <strong>
                    {% if bounce_rate["bounce_status"] == "warning" %}
                    {{ _('Caution:') }}
                    {% elif bounce_rate["bounce_status"] == "critical" %}
                    {{ _('Critical:') }}
                    {% endif %}
                </strong>
                {% if bounce_rate["bounce_percentage"] < 0.1 %}
                  {{ _('Less than') }} 0.1%
                {% else %}
                  {{ bounce_rate["bounce_percentage"]|round(2) }}%
                {% endif %}
                 {{ _('of email addresses need review') }}
            </p>
        </div>

        <h2 class="heading-medium mt-8">{{ _('Problem emails over the past 24 hours') }}</h2>


        {# {{ ajax_block(partials, updates_url, 'problem_emails', interval=5)}} #}
        <div class="ajax-block-container">
            <ul class="list list-bullet">
            {% for job in jobs %}
                {% if job["bounce_count"] > 0 %}
                    <li>
                        <a href="{{ url_for('.view_job', service_id=current_service.id, job_id=job.id, status='failed') }}">
                            {{ job["bounce_count"] }}
                            {% if job["bounce_count"] > 1 %}
                                {{_(' problem email addresses')}}
                            {%- else -%}
                                {{_(' problem email address')}}
                            {%- endif -%}
                        </a>
                        <span>
                            {{ _( ' in ')}} '{{ job.original_file_name }}'
                        </span>
                    </li>
                {% endif %}
            {% endfor %}
            {% for notification in one_offs %}
                <li>
                    <a href="{{ url_for('.view_notification', service_id=current_service.id, notification_id=notification.id) }}">{{notification["to"]}}</a>
                    <span>
                        {{ _( ' using template ')}} '{{ notification["template"]["name"] }}'
                    </span>
                </li>
            {% endfor %}
            </ul>
            {{ show_more(
                url_for('.view_notifications', service_id=current_service.id, message_type='email', status='permanent-failure', pe_filter='true'),
                _("See all problem email addresses")
            ) }}
            {# <p class="text-small">{{ _('Updated every 5 minutes. Last updated {}').format("2023-03-20")}}</p> #}
        </div>

    </div>
{% endblock %}
