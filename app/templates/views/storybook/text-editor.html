

<div class="grid grid-rows-[47px_56px_1fr] h-full">
<div id="toolbar">
  <!-- Add font size dropdown -->
  <select class="ql-header">
    <option value="3">Heading 3</option>
    <option value="2">Heading 2</option>
    <!-- Note a missing, thus falsy value, is used to reset to default -->
    <option selected value="false">Normal</option>
  </select>
  <button id="var-button" value="var" aria-label="Insert variable">((var))</button>
  <button class="ql-bold" aria-label="Bold"><i class="fa fa-bold"></i></button>
  <button class="ql-italic" aria-label="Italic"><i class="fa fa-italic"></i></button>
  <button class="ql-list" value="ordered" aria-label="Insert ordered list"><i class="fa fa-list-ol"></i></button>
  <button class="ql-list" value="bullet" aria-label="Insert bullet list"><i class="fa fa-list-ul"></i></button>
  <button class="ql-indent" value="increase" aria-label="Increase indent"><i class="fa fa-indent"></i></button>
  <button class="ql-indent" value="decrease" aria-label="Decrease indent"><i class="fa fa-outdent"></i></button>
  <button id="divider-button" value="divider" aria-label="Insert divider">Divider</button>
  <button class="ql-link" aria-label="Insert link"><i class="fa fa-link"></i></button>
  <button class="ql-blockquote" aria-label="Insert blockquote"><i class="fa fa-quote-left"></i></button>
  <button id="en-lang-button" value="en-CA" aria-label="Insert English block">EN</button>
  <button id="fr-lang-button" value="fr-CA" aria-label="Insert French block">FR</button>
  <button class="ql-direction" value="rtl" aria-label="Change text direction to right-to-left"></button>
</div>
<div id="branding">
    <img
          alt="{{ _('Government of Canada') }}"
          height="32px"
          class="h-full w-auto"
          src="{{ asset_s3_url('gov-canada-en.svg') }}"
          contenteditable="false"
        />
</div>
<div id="editor">
  <p>Hello World!</p>
  <p>Some initial <strong>bold</strong> text</p>
  <p><br /></p>
</div>
</div>
<script nonce="{{ request_nonce }}">

  const Inline = Quill.import('blots/inline');
  const BlockEmbed = Quill.import('blots/block/embed');
  const Block = Quill.import('blots/block');
  const Container = Quill.import('blots/container');
  const Delta = Quill.import('delta');
  const icons = Quill.import('ui/icons');

icons['bold'] = '<i class="fa-solid fa-bold"></i>';
icons['link'] = '<i class="fa-solid fa-link"></i>';
icons['direction'] = {
  '': '<i class="fa-solid fa-arrow-right-arrow-left"></i>',      // LTR
  'rtl': '<i class="fa-solid fa-arrow-right-arrow-left"></i>'   // RTL
};

const onClick = (selector, callback) => {
  document.querySelectorAll(selector).forEach(element => {
    element.addEventListener('click', callback);
  });
};


class DividerBlot extends BlockEmbed {
  static blotName = 'divider';
  static tagName = 'hr';
}

Quill.register(DividerBlot);

class VarBlot extends Inline {
  static blotName = 'var';
  static tagName = 'span';
  static className = 'placeholder';
}

Quill.register(VarBlot);

class LanguageWrapperBlot extends Container {
  static blotName = 'lang';
  static tagName = 'div';
  static className = 'language-block';
  static allowedChildren = [Block];

  static create(value) {
    const node = super.create();
    node.setAttribute('lang', value);
    node.setAttribute('data-language', value);    
    return node;
  }

  static formats(node) {
    return node.getAttribute('lang');
  }
}

Quill.register(LanguageWrapperBlot, true);

onClick('#en-lang-button, #fr-lang-button', (event) => {
  const lang = event.currentTarget.value;
  const range = quill.getSelection(true);
  const [line, offset] = quill.getLine(range.index);

  console.log(lang, line, offset);
  console.log('Button clicked:', event.currentTarget.id, 'with value:', lang);
  // Creating an empty language block
    quill.insertText(range.index, '\n');
    quill.formatLine(range.index, 1, 'lang', lang);
    
    // Insert empty paragraph in the language block
    quill.insertText(range.index, ' ');
    quill.deleteText(range.index, 1); // Remove the space
    
    // Position cursor in the block
    quill.setSelection(range.index, 0);
});

onClick('#var-button', () => {
  // Add (( before the selection range
  const range = quill.getSelection(true);
  if (range) {
    const selectedText = quill.getText(range.index, range.length);
    quill.deleteText(range.index, range.length);
    quill.insertText(range.index, `((${selectedText}))`, 'var', Quill.sources.USER);
    // Optionally, restore selection
    quill.setSelection(range.index + 2, selectedText.length);
  }
  // If no selection, just insert (( at the current cursor position
  else {
    quill.insertText(quill.getSelection().index, '((', 'var', Quill.sources.USER);
    quill.setSelection(quill.getSelection().index + 3, Quill.sources.SILENT);
  }
  // Ensure the variable is formatted correctly 
  quill.format('var', true);
});
onClick('#divider-button', () => {
  const range = quill.getSelection(true);
  quill.insertText(range.index, '\n', Quill.sources.USER);
  quill.insertEmbed(range.index + 1, 'divider', true, Quill.sources.USER);
  quill.setSelection(range.index + 2, Quill.sources.SILENT);
});

  const bindings = {
    tab: {
    key: 9,
    handler: function() {
      // Handle tab
      // focus on next interactive element
      return true
    }
  },
  }
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: '#toolbar',
      keyboard: {
        bindings: bindings
      }
    }
  });

  window.quill = quill;
function makeQuillLinkActionsAccessible() {
  const actions = document.querySelectorAll('.ql-tooltip .ql-action, .ql-tooltip .ql-remove');
  actions.forEach(el => {
    el.setAttribute('tabindex', '0');
    el.setAttribute('role', 'button');
    if (el.classList.contains('ql-action')) el.setAttribute('aria-label', 'Edit link');
    if (el.classList.contains('ql-remove')) el.setAttribute('aria-label', 'Remove link');

    // Remove any previous handler to avoid duplicates
    el.removeEventListener('keydown', quillLinkActionKeyHandler);
    el.addEventListener('keydown', quillLinkActionKeyHandler);
  });
}

function quillLinkActionKeyHandler(e) {
  if (e.key === ' ' || e.key === 'Enter' || e.keyCode === 32 || e.keyCode === 13) {
    e.preventDefault();
    e.stopPropagation();
    this.click();
  }
}

quill.on('selection-change', function(range) {
  if (range) setTimeout(makeQuillLinkActionsAccessible, 0);
});

// Add custom handler for variable button
const toolbar = quill.getModule('toolbar');
toolbar.addHandler('var', function() {
  const range = quill.getSelection();
  if (range && range.length > 0) {
    const selectedText = quill.getText(range.index, range.length);
    quill.deleteText(range.index, range.length);
    quill.insertText(range.index, `((${selectedText}))`);
    // Optionally, restore selection
    quill.setSelection(range.index + 2, selectedText.length);
  }
});


</script>