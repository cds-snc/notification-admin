

<div id="toolbar">
  <!-- Add font size dropdown -->
  <select class="ql-size">
    <option value="small">Heading 3</option>
    <option value="large">Heading 2</option>
    <!-- Note a missing, thus falsy value, is used to reset to default -->
    <option selected value="">Normal</option>
  </select>
  <button class="ql-direction" value="rtl"></button>
  <!-- Add a bold button -->
  <button class="ql-bold"><i class="fa fa-bold"></i></button>
  <button class="ql-link"><i class="fa fa-link"></i></button>
  <!-- Add subscript and superscript buttons -->
  <button id="divider-button" value="divider">â€“</button>
  <button id="var-button" value="var">((var))</button>
</div>
<div id="editor">
  <p>Hello World!</p>
  <p>Some initial <strong>bold</strong> text</p>
  <p><br /></p>
</div>

<script nonce="{{ request_nonce }}">

  const Inline = Quill.import('blots/inline');
  const BlockEmbed = Quill.import('blots/block/embed');
const icons = Quill.import('ui/icons');

icons['bold'] = '<i class="fa-solid fa-bold"></i>';
icons['link'] = '<i class="fa-solid fa-link"></i>';
icons['direction'] = {
  '': '<i class="fa-solid fa-arrow-right-arrow-left"></i>',      // LTR
  'rtl': '<i class="fa-solid fa-arrow-right-arrow-left"></i>'   // RTL
};
class DividerBlot extends BlockEmbed {
  static blotName = 'divider';
  static tagName = 'hr';
}

Quill.register(DividerBlot);

class VarBlot extends Inline {
  static blotName = 'var';
  static tagName = 'span';
  static className = 'placeholder';
}

Quill.register(VarBlot);
const onClick = (selector, callback) => {
  document.querySelector(selector).addEventListener('click', callback);
};

onClick('#var-button', () => {
  // Add (( before the selection range
  const range = quill.getSelection(true);
  if (range) {
    const selectedText = quill.getText(range.index, range.length);
    quill.deleteText(range.index, range.length);
    quill.insertText(range.index, `((${selectedText}))`, 'var', Quill.sources.USER);
    // Optionally, restore selection
    quill.setSelection(range.index + 2, selectedText.length);
  }
  // If no selection, just insert (( at the current cursor position
  else {
    quill.insertText(quill.getSelection().index, '((', 'var', Quill.sources.USER);
    quill.setSelection(quill.getSelection().index + 3, Quill.sources.SILENT);
  }
  // Ensure the variable is formatted correctly 
  quill.format('var', true);
});
onClick('#divider-button', () => {
  const range = quill.getSelection(true);
  quill.insertText(range.index, '\n', Quill.sources.USER);
  quill.insertEmbed(range.index + 1, 'divider', true, Quill.sources.USER);
  quill.setSelection(range.index + 2, Quill.sources.SILENT);
});

  const bindings = {
    tab: {
    key: 9,
    handler: function() {
      // Handle tab
      // focus on next interactive element
      return true
    }
  },
  }
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: '#toolbar',
      keyboard: {
        bindings: bindings
      }
    }
  });

  window.quill = quill;
function makeQuillLinkActionsAccessible() {
  const actions = document.querySelectorAll('.ql-tooltip .ql-action, .ql-tooltip .ql-remove');
  actions.forEach(el => {
    el.setAttribute('tabindex', '0');
    el.setAttribute('role', 'button');
    if (el.classList.contains('ql-action')) el.setAttribute('aria-label', 'Edit link');
    if (el.classList.contains('ql-remove')) el.setAttribute('aria-label', 'Remove link');

    // Remove any previous handler to avoid duplicates
    el.removeEventListener('keydown', quillLinkActionKeyHandler);
    el.addEventListener('keydown', quillLinkActionKeyHandler);
  });
}

function quillLinkActionKeyHandler(e) {
  if (e.key === ' ' || e.key === 'Enter' || e.keyCode === 32 || e.keyCode === 13) {
    e.preventDefault();
    e.stopPropagation();
    this.click();
  }
}

quill.on('selection-change', function(range) {
  if (range) setTimeout(makeQuillLinkActionsAccessible, 0);
});

// Add custom handler for variable button
const toolbar = quill.getModule('toolbar');
toolbar.addHandler('var', function() {
  const range = quill.getSelection();
  if (range && range.length > 0) {
    const selectedText = quill.getText(range.index, range.length);
    quill.deleteText(range.index, range.length);
    quill.insertText(range.index, `((${selectedText}))`);
    // Optionally, restore selection
    quill.setSelection(range.index + 2, selectedText.length);
  }
});


</script>