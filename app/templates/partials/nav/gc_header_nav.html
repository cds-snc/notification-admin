<hr class="m-0 md:hidden bg-blue" style="height: 4px"/>
<nav class="md:hidden" aria-label="{{ _('main navigation') }}">
  <div class="container">
    <!-- Mobile menu and nav bar -->
    <div class="grid grid-cols-2">
      {% if not current_user.is_authenticated or platform_admin_view_ind %}
        <div class="py-2">
          <a href="#" id="menu"
            class="mr-5 p-4 bg-blue text-white visited:text-white link:text-white no-underline focus:bg-blue focus:outline-none">
          {{ _('Menu') }}
          <img
            alt="Menu expansion arrow"
            aria-hidden="true"
            class="mobile-arrow ml-2 inline"
            src="{{ asset_url('images/arrow-white.svg') }}"
            width="20"/>
          </a>
        </div>
      {% else %}
        {% if not current_org %}
          {% if current_service.name and current_user.has_permissions() %}
            <div class="py-2">
              <a href="#" id="menu"
                class="mr-5 p-4 bg-blue text-white visited:text-white link:text-white no-underline focus:bg-blue focus:outline-none">
              {{ _('Menu') }}
              <img
                alt="Menu expansion arrow"
                aria-hidden="true"
                class="mobile-arrow ml-2 inline"
                src="{{ asset_url('images/arrow-white.svg') }}"
                width="20"/>
              </a>
            </div>
          {% else %}
            <div></div>
          {% endif %}
        {% endif %}
      {% endif %}

      <div aria-label="{{ _('language and sign-in') }}" class="flex justify-end self-center">
        {% if current_user.is_authenticated %}
          {% include 'account_menu_mobile.html' %}
        {% else %}
          <div class="self-center">
            <a
              href="{{ url_for('main.sign_in' ) }}"
              class="px-5 line-under leading-none inline-block text-blue visited:text-blue link:text-blue text-small underline hover:no-underline">
              {{ _('Sign in') }}
            </a>
          </div>
        {% endif %}
        <div class="px-5">
          <div class="h-14 p-1 border-2 border-solid border-gray rounded-lg">
            <a
              class="p-0 line-under leading-none inline text-blue visited:text-blue link:text-blue text-small underline hover:no-underline"
              href="{{ url_for('main.set_lang') }}?from={{ request.path }}">
              {% if session["userlang"] == "en" %}FR{% else %}EN{% endif %}
            </a>
          </div>
        </div>
      </div>
      <!-- Mobile menu and nav bar END -->
      <!-- MD-LG menu and nav bar -->
    </div>
  </div>
</nav>
{% if withnav %}
  <nav class="bg-gray xs:hidden smaller:hidden sm:hidden md:flex" aria-label="{{ _('main navigation') }}">
    <div class="container">
      <div id="proposition-links" class="flex flex-no-wrap">
        {% if not current_user.is_authenticated %}
          <div
            class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('home') }}">
            <a href="/"
               class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
            >{{ _('Home') }}</a>
          </div>
          <div
            class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('why-notify') }}">
            <a href="{{ url_for('main.why-notify') }}"
               class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
            >{{ _('Why GC Notify') }}</a>
          </div>
          <div
            class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('features') }}">
            <a href="{{ url_for('main.features') }}"
               class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
            >{{ _('Features') }}</a>
          </div>
          <div
            class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('documentation') }}">
            <a
              href="{{ documentation_url() }}"
              target="_blank"
              class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
            >{{ _('Documentation') }}</a>
          </div>
          <div
            class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('contact') }}">
            <a
              href="{{ url_for('main.contact') }}"
              class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
            >{{ _('Contact us') }}
            </a>
          </div>

        {% endif %}
        {% if current_user.is_authenticated and not current_org %}
          {% if current_user.platform_admin and current_user.has_permissions() %}
            <div
              class="flex-shrink-0 text-center p-5 bg-gray">
              <a href="{{ url_for('main.live_services') }}"
                 class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
              >{{ _('Platform admin') }}</a>
            </div>
          {% endif %}
          {% if current_service.name %}
            {% if current_user.has_permissions('view_activity') %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('dashboard') }}">
                <a href="{{ url_for('.service_dashboard', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('Dashboard') }}</a>
              </div>
            {% endif %}

            {% if current_user.has_permissions() %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('templates') }}">
                <a href="{{ url_for('.choose_template', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('Templates') }}</a>
              </div>
              {% if not current_user.has_permissions('view_activity') %}
                <div
                  class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('sent-messages') }}">
                  <a
                    href="{{ url_for('.view_notifications', service_id=current_service.id, status='sending,delivered,failed') }}"
                    class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                  >{{ _('Sent messages') }}</a>
                </div>
                {% if current_service.has_jobs %}
                  <div
                    class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('uploaded-files') }}">
                  <a
                    href="{{ url_for('.view_jobs', service_id=current_service.id) }}"
                    class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                  >{{ _('Uploaded files') }}</a>
                {% endif %}
              {% endif %}
            {% endif %}
            {% if current_user.has_permissions('manage_api_keys') %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('api-integration') }}">
                <a href="{{ url_for('.api_integration', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('API integration') }}</a>
              </div>
            {% endif %}
            {% if current_user.has_permissions() %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('team-members') }}">
                <a href="{{ url_for('.manage_users', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('Team members') }}</a>
              </div>
            {% endif %}
            {% if current_user.has_permissions('manage_api_keys', 'manage_service') %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('settings') }}">
                <a href="{{ url_for('.service_settings', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('Settings') }}</a>
              </div>
            {% endif %}
            {% if current_user.platform_admin and current_user.has_permissions() %}
              <div
                class="flex-shrink-0 text-center p-5 bg-gray header--{{ header_navigation.is_selected('smtp-integration') }}">
                <a href="{{ url_for('main.smtp_integration', service_id=current_service.id) }}"
                   class="text-smaller text-blue visited:text-blue link:text-blue font-bold no-underline hover:underline"
                >{{ _('SMTP') }}</a>
              </div>
            {% endif %}

          {% endif %}
        {% endif %}
        </div>
        <!-- MD-LG menu and nav bar END -->
      </div>
  </nav>
  <hr class="m-0 xs:hidden smaller:hidden sm:hidden md:flex"/>
{% endif %}
<script>
  function safeAddEventListener(selector, event, fn) {
    if (document.querySelector(selector))
      document.querySelector(selector).addEventListener(event, fn)
  }

  function registerMenuEscape(selector, toggleFn) {
    document.addEventListener("keydown", function (e) {
      if (e.key == 'Escape') {
        var opened = document.querySelector(selector + ':not(.hidden)')
        if (opened) toggleFn()
      }
    })
  }

  function classToggle() {
    const nav = document.querySelector(".mobile-nav")
    const arrow = document.querySelector(".mobile-arrow")
    nav.classList.toggle("hidden")
    arrow.classList.toggle("flip")
  }

  function accountMobileToggle() {
    const accountMenu = document.querySelector("#account-menu-mobile")
    accountMenu.classList.toggle("hidden")
    // In order to have the opacity transition effect working properly,
    // we need to separate the hidden and opacity toggling in two separate 
    // actions in the HTML rendering, hence the delay of opacity by 1 ms.
    window.setTimeout(function () {
      accountMenu.classList.toggle("opacity-0")
      accountMenu.classList.toggle("pointer-events-none")
    }, 1)
  }

  function accountMenuToggle() {
    const accountMenu = document.querySelector("#account-menu-options")
    const arrow = document.querySelector(".account-menu-arrow")
    accountMenu.classList.toggle("hidden")
    arrow.classList.toggle("flip")
  }

  safeAddEventListener("#menu", "click", classToggle)
  registerMenuEscape(".mobile-nav", classToggle)

  safeAddEventListener("#account-icon-mobile", "click", accountMobileToggle)
  safeAddEventListener("#account-close-mobile", "click", accountMobileToggle)
  registerMenuEscape("#account-menu-mobile", accountMobileToggle)

  safeAddEventListener("#account-menu", "click", accountMenuToggle)
  registerMenuEscape("#account-menu-options", accountMenuToggle)

</script>
